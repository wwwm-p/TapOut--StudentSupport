<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Message Portal</title>
<style>
  body { font-family: sans-serif; margin:0; }
  .page { display:none; padding:20px; }
  .page.active { display:block; }
  .overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
             background: rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  .modal-content { background:#fff; padding:20px; border-radius:8px; max-width:400px; width:90%; }
  button { margin:5px; padding:10px 15px; }
</style>
</head>
<body>

<!-- PAGE 1: Reason Selection -->
<div id="page1" class="page active">
  <h2>Select Reason</h2>
  <button onclick="chooseReason('Academic Help')">Academic Help</button>
  <button onclick="chooseReason('Mental Health')">Mental Health</button>
  <button onclick="chooseReason('Other')">Other</button>
</div>

<!-- PAGE 2: Urgency -->
<div id="page2" class="page">
  <h2>How urgent is this?</h2>
  <button onclick="chooseUrgency('I’m in Crisis')">I’m in Crisis</button>
  <button onclick="chooseUrgency('I’m Not Coping Well')">I’m Not Coping Well</button>
  <button onclick="chooseUrgency('Feeling a Little Off')">Feeling a Little Off</button>
  <button onclick="chooseUrgency('I’m Doing Fine – Just Curious')">I’m Doing Fine – Just Curious</button>
</div>

<!-- PAGE 3: Counselor Selection -->
<div id="page3" class="page">
  <h2>Select Counselor</h2>
  <button onclick="openModal('miap2k10','miap2k10@example.com')">M. Apel</button>
  <button onclick="openModal('kmcconnell','kmcconnell@example.com')">K. McConnell</button>
</div>

<!-- MODAL: Student Info -->
<div id="modalOverlay" class="overlay">
  <div class="modal-content">
    <h3>Enter your info</h3>
    <input id="firstName" placeholder="First Name"><br>
    <input id="lastName" placeholder="Last Name"><br>
    <input id="studentGrade" placeholder="Grade"><br>
    <input id="studentId" placeholder="Student ID"><br>
    <textarea id="extraNotes" placeholder="Extra Notes"></textarea><br>
    <button onclick="submitMessage()">Submit</button>
    <button onclick="closeModal()">Cancel</button>
  </div>
</div>

<!-- OVERLAY: Crisis Warning -->
<div id="crisisOverlay" class="overlay">
  <div class="modal-content">
    <h3>⚠️ Crisis Warning</h3>
    <p>Please make sure to contact your counselor immediately.</p>
    <button onclick="continueFromCrisis()">Continue</button>
  </div>
</div>

<!-- OVERLAY: Success Confirmation -->
<div id="successOverlay" class="overlay">
  <div class="modal-content">
    <h3>✅ Message Sent</h3>
    <button onclick="closeSuccess()">Close</button>
  </div>
</div>

<script>
let selectedReason = "";
let selectedUrgency = "";
let selectedCounselor = "";
let selectedCounselorEmail = "";

// Page navigation
function goToPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  const page = document.getElementById(id);
  if(page) page.classList.add("active");
}

// Reason selection
function chooseReason(reason) {
  selectedReason = reason;
  goToPage("page2");
}

// Urgency selection
function chooseUrgency(urgency) {
  selectedUrgency = urgency;
  if (urgency === "I’m in Crisis") openCrisisModal();
  else goToPage("page3");
}

// Crisis overlay
function openCrisisModal() { document.getElementById("crisisOverlay").style.display="flex"; }
function closeCrisisModal() { document.getElementById("crisisOverlay").style.display="none"; }
function continueFromCrisis() { closeCrisisModal(); goToPage("page3"); }

// Modal overlay
function openModal(username,email) {
  selectedCounselor = username;
  selectedCounselorEmail = email;
  document.getElementById("modalOverlay").style.display="flex";
}
function closeModal() { document.getElementById("modalOverlay").style.display="none"; }

// Success overlay
function openSuccess() { document.getElementById("successOverlay").style.display="flex"; }
function closeSuccess() { document.getElementById("successOverlay").style.display="none"; goToPage("page1"); }

// Submit message (SIS-ready)
async function submitMessage() {
  const firstName = document.getElementById("firstName")?.value.trim();
  const lastName = document.getElementById("lastName")?.value.trim();
  const grade = document.getElementById("studentGrade")?.value.trim();
  const studentId = document.getElementById("studentId")?.value.trim();
  const notes = document.getElementById("extraNotes")?.value.trim();

  if(!firstName || !lastName || !grade || !studentId){
    alert("Please fill in all required fields."); return;
  }

  // SIS verification
  try {
    const res = await fetch("/api/verifyStudent",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({studentId, firstName, lastName})
    });
    const verify = await res.json();
    if(!verify.valid){ alert("Student ID not recognized."); return; }
  } catch(err){ console.error(err); alert("Failed to verify student ID."); return; }

  const entry = {
    firstName,lastName,grade,studentId,notes,
    reason:selectedReason,urgency:selectedUrgency,
    counselor:selectedCounselor,counselorEmail:selectedCounselorEmail,
    dateTime:new Date().toISOString()
  };

  try {
    const res = await fetch("/api/messages",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(entry)
    });
    const data = await res.json();
    if(!data.success) throw new Error("Failed");

    // Optional localStorage copy
    const existing = JSON.parse(localStorage.getItem("studentMessages")||"[]");
    existing.push(entry);
    localStorage.setItem("studentMessages", JSON.stringify(existing));

    closeModal(); openSuccess();

    // Reset form
    ["firstName","lastName","studentGrade","studentId","extraNotes"].forEach(id=>{
      const el = document.getElementById(id); if(el) el.value="";
    });
    selectedReason = ""; selectedUrgency = ""; selectedCounselor = ""; selectedCounselorEmail = "";

  } catch(err){ console.error(err); alert("Failed to send message."); }
}
</script>

</body>
</html>
